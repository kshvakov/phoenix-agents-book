<!DOCTYPE html>
<html lang="{{ .Language.Lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{- $desc := "" -}}
    {{- if .Params.description -}}
        {{- $desc = .Params.description -}}
    {{- else if .Description -}}
        {{- $desc = .Description -}}
    {{- else if .Summary -}}
        {{- $desc = .Summary -}}
    {{- else if .Site.Params.description -}}
        {{- $desc = .Site.Params.description -}}
    {{- end -}}
    <meta name="description" content="{{ $desc | plainify | truncate 160 }}">

    {{ if .Site.Params.yandex_verification }}
    <meta name="yandex-verification" content="{{ .Site.Params.yandex_verification }}" />
    {{ end }}
    {{ if .Site.Params.google_verification }}
    <meta name="google-site-verification" content="{{ .Site.Params.google_verification }}" />
    {{ end }}

    {{- $gaID := .Site.Params.google_analytics_id | default "G-42YNTP8CJM" -}}
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ $gaID }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', '{{ $gaID }}');
    </script>

    <title>{{ if and .Title (not .IsHome) }}{{ .Title }} — {{ end }}{{ .Site.Title }}. {{ .Site.Params.headerTitle | default "Кирилл Шваков" }}</title>

    <link rel="icon" type="image/svg+xml" href="{{ "favicon.svg" | relURL }}">
    <link rel="stylesheet" href="{{ "assets/site.css" | relURL }}">

    {{- with .Site.Home.OutputFormats.Get "RSS" -}}
    <link rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }} RSS" href="{{ .Permalink }}">
    {{- end -}}

    <link rel="canonical" href="{{ .Permalink }}">

    {{ range .AllTranslations }}
    <link rel="alternate" hreflang="{{ .Language.Lang }}" href="{{ .Permalink }}">
    {{ end }}
    <link rel="alternate" hreflang="x-default" href="{{ .Sites.Default.Home.Permalink }}">

    {{- $ogImage := .Site.Params.og_image -}}
    {{- $ogImageAbs := "" -}}
    {{- if $ogImage -}}
        {{- $ogImageAbs = ($ogImage | absURL) -}}
    {{- end -}}

    {{- $ogLocale := "" -}}
    {{- if eq .Language.Lang "ru" -}}
        {{- $ogLocale = "ru_RU" -}}
    {{- else if eq .Language.Lang "en" -}}
        {{- $ogLocale = "en_US" -}}
    {{- else -}}
        {{- $ogLocale = .Language.Lang -}}
    {{- end -}}

    <meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
    <meta property="og:title" content="{{ if and .Title (not .IsHome) }}{{ .Title }} — {{ end }}{{ .Site.Title }}">
    <meta property="og:description" content="{{ $desc | plainify | truncate 160 }}">
    <meta property="og:url" content="{{ .Permalink }}">
    <meta property="og:site_name" content="{{ .Site.Title }}">
    {{- if $ogLocale -}}
    <meta property="og:locale" content="{{ $ogLocale }}">
    {{- end -}}
    {{- range .AllTranslations -}}
        {{- if ne .Language.Lang $.Language.Lang -}}
    <meta property="og:locale:alternate" content="{{ if eq .Language.Lang "ru" }}ru_RU{{ else if eq .Language.Lang "en" }}en_US{{ else }}{{ .Language.Lang }}{{ end }}">
        {{- end -}}
    {{- end -}}
    {{- if $ogImageAbs -}}
    <meta property="og:image" content="{{ $ogImageAbs }}">
    {{- end -}}

    <meta name="twitter:card" content="{{ if $ogImageAbs }}summary_large_image{{ else }}summary{{ end }}">
    <meta name="twitter:title" content="{{ if and .Title (not .IsHome) }}{{ .Title }} — {{ end }}{{ .Site.Title }}">
    <meta name="twitter:description" content="{{ $desc | plainify | truncate 200 }}">
    {{- if $ogImageAbs -}}
    <meta name="twitter:image" content="{{ $ogImageAbs }}">
    {{- end -}}

    {{ block "head" . }}{{ end }}
</head>
<body>
    {{- $showBookNav := or (eq .Section "chapters") (eq .Section "appendix") -}}
    {{ if .IsPage }}
    <div class="reading-progress">
        <div class="reading-progress__bar"></div>
    </div>
    <button class="scroll-to-top" aria-label="{{ if eq .Language.Lang "ru" }}Наверх{{ else }}Scroll to top{{ end }}">
        <span class="scroll-to-top__icon">↑</span>
    </button>
    {{ if $showBookNav }}
    <button
        id="book-nav-toggle"
        class="book-nav-fab"
        type="button"
        aria-controls="book-nav-drawer"
        aria-expanded="false"
        aria-label="{{ if eq .Language.Lang "ru" }}Оглавление{{ else }}Contents{{ end }}"
    >
        <span class="book-nav-fab__icon" aria-hidden="true">≡</span>
        <span class="visually-hidden">{{ if eq .Language.Lang "ru" }}Оглавление{{ else }}Contents{{ end }}</span>
    </button>
    {{ end }}
    {{ end }}

    <div class="container">
        <header>
            <h1>
                <a href="/" style="text-decoration: none; color: inherit;">
                    <span class="site-title">
                        <span class="site-title__name">{{ .Site.Params.headerTitle | default "Кирилл Шваков" }}</span>
                        <span class="site-title__subtitle">{{ .Site.Title }}</span>
                    </span>
                </a>
            </h1>
            <div class="header-controls">
                <button id="theme-toggle" class="theme-btn" aria-label="Toggle theme">
                    <span class="theme-icon">☀</span>
                </button>
                <div class="lang-switcher">
                    {{- $langLinks := newScratch -}}
                    {{- range $.AllTranslations -}}
                        {{- $langLinks.Set .Language.Lang .RelPermalink -}}
                    {{- end -}}
                    {{- range .Sites -}}
                        {{- $lang := .Language.Lang -}}
                        {{- $isActive := eq $lang $.Site.Language.Lang -}}
                        {{- $url := $langLinks.Get $lang -}}
                        {{- if not $url -}}
                            {{- $url = .Home.RelPermalink -}}
                        {{- end -}}
                        <a class="lang-btn{{ if $isActive }} active{{ end }}"
                           href="{{ $url }}"
                           lang="{{ $lang }}"
                           hreflang="{{ $lang }}"
                           {{ if $isActive }}aria-current="page"{{ end }}>{{ .Language.LanguageName }}</a>
                    {{- end -}}
                </div>
            </div>
        </header>

        <main>
            {{ block "main" . }}{{ end }}
        </main>
    </div>

    {{ partial "nav-drawer.html" . }}

    {{- $authorName := .Site.Params.author_name | default (.Site.Params.headerTitle | default "Кирилл Шваков") -}}
    {{- $authorUrl := .Site.Params.author_url | default "https://kshvakov.github.io/" -}}
    {{- $siteUrl := .Site.Home.Permalink -}}
    {{- $websiteId := printf "%s#website" $siteUrl -}}
    {{- $bookId := printf "%s#book" $siteUrl -}}
    {{- $personId := printf "%s#person" $authorUrl -}}

    {{- $person := dict
        "@type" "Person"
        "@id" $personId
        "name" $authorName
        "url" $authorUrl
    -}}

    {{- $website := dict
        "@type" "WebSite"
        "@id" $websiteId
        "url" $siteUrl
        "name" .Site.Title
        "inLanguage" .Language.Lang
    -}}

    {{- $book := dict
        "@type" "Book"
        "@id" $bookId
        "name" .Site.Title
        "description" ($desc | plainify | truncate 300)
        "url" $siteUrl
        "inLanguage" .Language.Lang
        "author" $person
    -}}
    {{- if $ogImageAbs -}}
        {{- $book = merge $book (dict "image" $ogImageAbs) -}}
    {{- end -}}

    {{- $graph := slice $website $person $book -}}
    {{- if not .IsHome -}}
        {{- $crumbPages := slice -}}
        {{- range .Ancestors.Reverse -}}
            {{- $crumbPages = $crumbPages | append . -}}
        {{- end -}}
        {{- $crumbPages = $crumbPages | append . -}}

        {{- $crumbItems := slice -}}
        {{- range $i, $p := $crumbPages -}}
            {{- $name := $p.Title -}}
            {{- if $p.IsHome -}}
                {{- $name = (cond (eq $.Language.Lang "ru") "Главная" "Home") -}}
            {{- end -}}
            {{- $crumbItems = $crumbItems | append (dict
                "@type" "ListItem"
                "position" (add $i 1)
                "name" $name
                "item" $p.Permalink
            ) -}}
        {{- end -}}

        {{- $breadcrumbs := dict
            "@type" "BreadcrumbList"
            "itemListElement" $crumbItems
        -}}
        {{- $graph = $graph | append $breadcrumbs -}}
    {{- end -}}
    {{- if .IsPage -}}
        {{- $article := dict
            "@type" "Article"
            "headline" (.Title | default .Site.Title)
            "description" ($desc | plainify | truncate 300)
            "url" .Permalink
            "inLanguage" .Language.Lang
            "author" $person
            "isPartOf" (dict "@id" $bookId)
            "mainEntityOfPage" (dict "@type" "WebPage" "@id" .Permalink)
        -}}
        {{- with .Date -}}
            {{- $article = merge $article (dict "datePublished" (.Format "2006-01-02T15:04:05Z07:00")) -}}
        {{- end -}}
        {{- with .Lastmod -}}
            {{- $article = merge $article (dict "dateModified" (.Format "2006-01-02T15:04:05Z07:00")) -}}
        {{- end -}}
        {{- $graph = $graph | append $article -}}
    {{- end -}}

    {{- $jsonld := (dict "@context" "https://schema.org" "@graph" $graph | jsonify | safeJS) -}}
    <script type="application/ld+json">{{ $jsonld }}</script>

    <script src="{{ "assets/site.js" | relURL }}"></script>
    {{ if .Site.Params.metrika_id }}
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id={{ .Site.Params.metrika_id }}', 'ym');

        ym({{ .Site.Params.metrika_id }}, 'init', {ssr:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/{{ .Site.Params.metrika_id }}" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    {{ end }}
</body>
</html>

